# 实施计划

- [x] 1. 项目基础设置和依赖安装

  - 初始化 Node.js 项目结构，安装 Express、dotenv 等核心依赖
  - 创建基本的目录结构：controllers、services、models、config、views
  - 设置环境变量配置文件和示例配置
  - _需求: 2.3, 3.1_

- [x] 2. 支付配置管理实现

  - 创建 PaymentConfig 类，实现环境配置加载和管理
  - 实现沙箱和生产环境的配置切换逻辑
  - 编写配置类的单元测试
  - _需求: 3.1, 3.2, 2.3_

- [x] 3. 签名服务核心功能
- [x] 3.1 实现 RSA2 签名生成功能

  - 编写 SignatureService 类的签名生成方法
  - 实现参数排序和拼接逻辑
  - 创建签名生成的单元测试
  - _需求: 2.1, 2.2_

- [x] 3.2 实现签名验证功能

  - 编写签名验证方法，用于验证支付宝回调
  - 实现签名验证的错误处理
  - 创建签名验证的单元测试
  - _需求: 2.2, 4.4_

- [x] 4. 订单管理系统
- [x] 4.1 创建订单数据模型

  - 定义 Order 数据结构和验证规则
  - 实现订单状态枚举和状态转换逻辑
  - 编写订单模型的单元测试
  - _需求: 1.3, 4.1, 4.2_

- [x] 4.2 实现订单管理器

  - 编写 OrderManager 类，实现订单 CRUD 操作
  - 实现订单状态更新和查询功能
  - 使用 JSON 文件作为数据持久化方案
  - 创建订单管理的单元测试
  - _需求: 1.3, 4.1, 4.2_

- [x] 5. 核心支付服务实现
- [x] 5.1 实现支付订单创建

  - 编写 PaymentService 类的订单创建方法
  - 实现支付参数构建和验证逻辑
  - 集成订单管理器进行订单状态管理
  - 编写支付订单创建的单元测试
  - _需求: 1.1, 5.1, 5.2_

- [x] 5.2 实现支付 URL 生成

  - 编写支付 URL 生成方法，调用 alipay.trade.page.pay 接口
  - 实现支付参数签名和 URL 构建
  - 处理支付 URL 生成的异常情况
  - 创建支付 URL 生成的单元测试
  - _需求: 1.1, 5.2, 5.3_

- [x] 5.3 实现支付回调处理

  - 编写异步通知回调处理方法
  - 实现同步返回回调处理方法
  - 集成签名验证和订单状态更新
  - 编写回调处理的单元测试
  - _需求: 1.2, 1.3, 2.2, 4.3_

- [x] 6. Web 控制器和路由
- [x] 6.1 创建支付页面控制器

  - 实现 PaymentController 类的基本结构
  - 编写支付页面展示的控制器方法
  - 创建支付页面的 HTML 模板
  - 实现订单信息展示功能
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [x] 6.2 实现支付发起接口

  - 编写支付发起的 POST 接口
  - 集成支付服务进行订单创建和支付 URL 生成
  - 实现支付跳转逻辑
  - 添加请求参数验证和错误处理
  - _需求: 1.1, 5.1, 5.2_

- [x] 6.3 实现支付回调接口

  - 编写支付宝异步通知接收接口
  - 编写支付宝同步返回处理接口
  - 集成支付服务的回调处理方法
  - 实现回调接口的错误处理和日志记录
  - _需求: 1.2, 1.3, 4.3_

- [x] 7. 错误处理和日志系统
- [x] 7.1 实现统一错误处理

  - 创建 PaymentError 自定义错误类
  - 定义错误码常量和错误消息
  - 实现全局错误处理中间件
  - 编写错误处理的单元测试
  - _需求: 2.4, 4.4_

- [x] 7.2 实现日志记录系统

  - 集成日志库（如 winston）进行日志管理
  - 实现支付流程各环节的日志记录
  - 配置不同级别的日志输出
  - 创建日志记录的测试用例
  - _需求: 4.1, 4.2, 4.3, 4.4_

- [x] 8. Express 应用集成
- [x] 8.1 创建主应用文件

  - 编写 Express 应用的主入口文件
  - 配置中间件：body-parser、cors、静态文件服务
  - 集成所有路由和控制器
  - 实现应用启动和关闭逻辑
  - _需求: 1.1, 1.2_

- [x] 8.2 配置路由系统

  - 定义所有支付相关的路由
  - 实现路由参数验证中间件
  - 配置静态资源和模板引擎
  - 添加路由级别的错误处理
  - _需求: 1.1, 1.2, 5.1_

- [x] 9. 沙箱环境测试集成
- [x] 9.1 配置沙箱测试环境

  - 设置沙箱环境的配置参数
  - 创建测试用的支付宝应用配置
  - 实现环境切换的配置管理
  - 编写沙箱环境的集成测试
  - _需求: 3.1, 3.2, 3.3_

- [x] 9.2 实现端到端测试流程

  - 编写完整支付流程的自动化测试
  - 测试支付订单创建到支付完成的全流程
  - 验证回调处理和订单状态更新
  - 测试各种异常场景的处理
  - _需求: 3.3, 1.1, 1.2, 1.3, 1.4_

- [x] 10. 用户界面和体验优化
- [x] 10.1 创建支付页面 UI

  - 设计简洁的支付页面界面
  - 实现订单信息的清晰展示
  - 添加支付按钮和加载状态提示
  - 实现响应式设计适配移动端
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [x] 10.2 实现支付状态页面

  - 创建支付成功页面
  - 创建支付失败页面
  - 实现支付取消处理页面
  - 添加返回商户页面的导航
  - _需求: 1.3, 1.4, 5.4_

- [x] 11. 生产环境准备和文档
- [x] 11.1 创建部署配置

  - 编写生产环境的配置文件模板
  - 创建 Docker 配置文件（可选）
  - 编写部署脚本和启动脚本
  - 配置 PM2 或其他进程管理工具
  - _需求: 3.4_

- [x] 11.2 编写项目文档
  - 创建 README 文件，包含项目介绍和快速开始指南
  - 编写 API 接口文档
  - 创建配置说明和环境变量文档
  - 编写故障排除和常见问题解答
  - _需求: 2.3, 3.1, 4.4_
